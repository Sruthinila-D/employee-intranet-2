<div class="card p-4">
  <p-toast></p-toast>
  <p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

  <!-- TOOLBAR -->
  <p-toolbar styleClass="mb-4 gap-2">
    <ng-template pTemplate="left">
      <p-button 
        severity="success" 
        label="New Product" 
        icon="pi pi-plus" 
        (onClick)="openNew()" />
    </ng-template>
    <ng-template pTemplate="right">
      <p-selectButton 
        [options]="viewOptions" 
        [ngModel]="layout()" 
        (ngModelChange)="layout.set($event)"
        optionLabel="icon" 
        optionValue="value"
        [allowEmpty]="false">
        <ng-template let-item pTemplate="item">
          <i [class]="item.icon"></i>
        </ng-template>
      </p-selectButton>
    </ng-template>
  </p-toolbar>

  <!-- VIEW SWITCHER -->
  @switch (layout()) {
    
    <!-- TABLE VIEW -->
    @case ('table') {
      <p-table
        [value]="products()"
        [rows]="10"
        [paginator]="true"
        [rowHover]="true"
        dataKey="id"
        [tableStyle]="{ 'min-width': '60rem' }"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [showCurrentPageReport]="true">
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 5rem">Image</th>
            <th pSortableColumn="title">Name <p-sortIcon field="title"></p-sortIcon></th>
            <th pSortableColumn="price">Price <p-sortIcon field="price"></p-sortIcon></th>
            <th pSortableColumn="category">Category <p-sortIcon field="category"></p-sortIcon></th>
            <th pSortableColumn="rating">Rating <p-sortIcon field="rating"></p-sortIcon></th>
            <th pSortableColumn="inventoryStatus">Status <p-sortIcon field="inventoryStatus"></p-sortIcon></th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-product>
          <tr>
            <td><img [src]="product.thumbnail" [alt]="product.title" width="50" class="rounded shadow-1" /></td>
            <td>{{ product.title }}</td>
            <td>{{ product.price | currency:'USD' }}</td>
            <td>{{ product.category }}</td>
            <td><p-rating [ngModel]="product.rating" [readonly]="true"></p-rating></td>
            <td><p-tag [value]="product.inventoryStatus" [severity]="getSeverity(product)"></p-tag></td>
            <td>
              <div class="flex gap-2">
                <p-button icon="pi pi-pencil" [rounded]="true" [outlined]="true" severity="success" (onClick)="editProduct(product)"></p-button>
                <p-button icon="pi pi-trash" [rounded]="true" [outlined]="true" severity="danger" (onClick)="deleteProduct(product)"></p-button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    }

    <!-- DATA VIEW (LIST & GRID) -->
    @default {
      <div class="card">
        <!-- layout input strictly typed to 'list' | 'grid' -->
        <p-dataview 
            #dv 
            [value]="products()" 
            [layout]="layout() === 'list' ? 'list' : 'grid'" 
            [paginator]="true" 
            [rows]="6">
            
            <!-- LIST TEMPLATE (Use pTemplate="list") -->
            <ng-template #list let-items>
                <div class="flex flex-col">
                    @for (item of items; track item.id; let first = $first) {
                        <div class="flex flex-col sm:flex-row sm:items-center p-6 gap-4"
                            [class.border-t]="!first" class="border-surface-200">
                            
                            <!-- Image -->
                            <div class="md:w-40 relative">
                                <img class="block mx-auto rounded w-full" 
                                     [src]="item.thumbnail" 
                                     [alt]="item.title"
                                     style="max-width: 150px;" />
                                <p-tag [value]="item.inventoryStatus" [severity]="getSeverity(item)" 
                                       class="absolute" [style.left.px]="4" [style.top.px]="4" />
                            </div>

                            <!-- Details -->
                            <div class="flex flex-col md:flex-row justify-between md:items-center flex-1 gap-6">
                                <div class="flex flex-row md:flex-col justify-between items-start gap-2">
                                    <div>
                                        <span class="font-medium text-secondary text-sm">{{ item.category }}</span>
                                        <!-- Fixed: item.title instead of item.name -->
                                        <div class="text-lg font-medium mt-2">{{ item.title }}</div>
                                    </div>
                                    <div class="bg-surface-100 p-1" style="border-radius: 30px">
                                        <div class="bg-surface-0 flex items-center gap-2 justify-center py-1 px-2" style="border-radius: 30px;">
                                            <span class="font-medium text-sm">{{ item.rating }}</span>
                                            <i class="pi pi-star-fill text-yellow-500"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex flex-col md:items-end gap-5">
                                    <span class="text-xl font-semibold">{{ item.price | currency: 'USD' }}</span>
                                    <div class="flex flex-row gap-2">
                                        <p-button icon="pi pi-pencil" [outlined]="true" (onClick)="editProduct(item)"></p-button>
                                        <p-button icon="pi pi-trash" severity="danger" [outlined]="true" (onClick)="deleteProduct(item)"></p-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </ng-template>
    
            <!-- GRID TEMPLATE (Use pTemplate="grid") -->
            <ng-template #grid let-items>
                <div class="grid grid-cols-12 gap-4">
                    @for (item of items; track item.id) {
                        <div class="col-span-12 sm:col-span-6 md:col-span-4 xl:col-span-4 p-2">
                            <div class="p-6 border border-surface-200 bg-surface-0 rounded flex flex-col h-full relative">
                                <!-- Image -->
                                <div class="bg-surface-50 flex justify-center rounded p-4">
                                    <div class="relative mx-auto">
                                        <img class="rounded w-full" 
                                             [src]="item.thumbnail" 
                                             [alt]="item.title"
                                             style="max-width: 100%; height: 160px; object-fit: contain;" />
                                        <p-tag [value]="item.inventoryStatus" [severity]="getSeverity(item)" 
                                               class="absolute" [style.left.px]="4" [style.top.px]="4" />
                                    </div>
                                </div>
                                <!-- Content -->
                                <div class="pt-6 flex flex-col flex-1">
                                    <div class="flex flex-row justify-between items-start gap-2">
                                        <div class="overflow-hidden">
                                            <span class="font-medium text-secondary text-sm">{{ item.category }}</span>
                                            <div class="text-lg font-medium mt-1 truncate">{{ item.title }}</div>
                                        </div>
                                        <div class="bg-surface-100 p-1 rounded-full">
                                            <div class="bg-surface-0 flex items-center gap-2 justify-center py-1 px-2 rounded-full">
                                                <span class="font-medium text-sm">{{ item.rating }}</span>
                                                <i class="pi pi-star-fill text-yellow-500"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-4 mt-auto pt-4">
                                        <span class="text-2xl font-semibold">{{ item.price | currency: 'USD' }}</span>
                                        <div class="flex gap-2 w-full">
                                            <p-button icon="pi pi-pencil" class="flex-1" [outlined]="true" label="Edit" (onClick)="editProduct(item)"></p-button>
                                            <p-button icon="pi pi-trash" severity="danger" [outlined]="true" (onClick)="deleteProduct(item)"></p-button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </ng-template>
        </p-dataview>
      </div>
    }
  }

  <!-- DIALOG remains the same -->
  <p-dialog [(visible)]="productDialog" [style]="{ width: '450px' }" header="Product Details" [modal]="true">
      <!-- ... same content as before ... -->
      <ng-template pTemplate="content">
        <div class="field mb-4">
            <label for="name" class="font-bold block mb-2">Name</label>
            <input type="text" pInputText id="name" [(ngModel)]="product.title" class="w-full" />
        </div>
        <!-- Add other fields here -->
      </ng-template>
      <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" [text]="true" (onClick)="hideDialog()"></p-button>
        <p-button label="Save" icon="pi pi-check" [text]="true" (onClick)="saveProduct()"></p-button>
      </ng-template>
  </p-dialog>
</div>